<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>אפליקציית עישון</title>
  <style>
    :root{ --bg:#0b1020; --card:#121734; --muted:#9aa3b2; --text:#eaf0ff; --accent:#6ea8fe; --accent2:#70e1a1; --danger:#ff7a7a; --warn:#ffd166;}
    body{background:var(--bg);color:var(--text);font-family:Arial,system-ui;text-align:center;padding:18px;margin:0}
    .wrap{max-width:560px;margin:0 auto}
    h1{font-size:22px;margin:6px 0 12px}
    .row{display:flex;gap:10px;justify-content:center;align-items:center;flex-wrap:wrap}
    button,select{padding:12px 16px;margin:8px;border:none;border-radius:12px;font-size:16px;cursor:pointer}
    #btnStart{background:var(--accent)}
    #btnSmoke{background:var(--accent2)}
    #btnTest{background:#8bd0ff}
    #btnStopAlarm{background:var(--danger);display:none}
    .card{background:var(--card);padding:16px;margin:12px auto;border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,.25)}
    .stat{font-size:18px;margin:6px 0}
    .big{font-size:22px;font-weight:600}
    .hint{font-size:13px;color:var(--muted);margin-top:8px}
    .warn{color:var(--warn)}
  </style>
</head>
<body>
<div class="wrap">
  <h1>מעקב עישון</h1>

  <div class="row">
    <button id="btnStart">בצע</button>
    <button id="btnSmoke">עישנתי</button>
    <button id="btnTest">בדיקת צליל 🔊</button>
    <button id="btnStopAlarm">הפסק צליל</button>
    <div>
      <label for="divisorSel">חלוקה עד 22:00:</label><br>
      <select id="divisorSel">
        <option value="2" selected>2 חלקים</option>
        <option value="1">חלק אחד (עד 22:00)</option>
      </select>
    </div>
  </div>

  <div class="card">
    <div class="stat">חלוקה נוכחית: <span id="currentDiv">2</span></div>
    <div class="stat">היעד הבא: <span id="nextTime">—</span></div>
    <div class="stat big">זמן שנותר: <span id="countdown">—</span></div>
    <div class="hint" id="phaseHint">—</div>
  </div>

  <div class="card">
    <div class="stat">כמה עישנתי היום: <span id="todayCount">0</span></div>
    <div class="stat">ממוצע בין סיגריות: <span id="avgInterval">—</span></div>
    <div class="hint">הממוצע: מהלחיצה הראשונה, פחות 8 שעות לכל 24 שעות מלאות, לחלק במס’ הלחיצות פחות אחת.</div>
  </div>

  <audio id="alarm" preload="auto"></audio>
</div>

<script>
/* ====== קבצי צליל ====== */
const ALARM_FILES = ["alarm1.mp3","alarm2.mp3","alarm3.mp3"];

/* ====== Keys ====== */
const LS_STATE = "smokeAppState_v4";
const LS_PLAN  = "smokeAppPlan_v2";
const LS_DIV   = "smokeAppDivisor_v2";

/* ====== State ====== */
let state = {
  presses: [],
  firstPressTs: null,
  daily: { lastPivot: null, todayCount: 0 },
  dailyMap: {}
};

/* ====== Plan ====== */
let plan = {
  divisor: 2,
  startedAt: null,
  phase: 0,          // 0=אין, 1=חצי ראשון, 2=חצי שני עד 22:00, 3=עבר 22:00
  phaseEndTs: null,
  finalEndTs: null,
  alarmFired: false,
  alarmActive: false,
  alarmSrc: null
};

/* ====== Utils ====== */
function saveState(){ localStorage.setItem(LS_STATE, JSON.stringify(state)); }
function savePlan(){ localStorage.setItem(LS_PLAN, JSON.stringify(plan)); }

function loadAll(){
  const s = localStorage.getItem(LS_STATE);
  if(s){ try{ state = JSON.parse(s); }catch{} }

  if(!state.presses?.length){
    const s3 = localStorage.getItem("smokeAppState_v3");
    if(s3){
      try{
        const old = JSON.parse(s3);
        state.presses = Array.isArray(old.presses) ? old.presses : [];
        state.firstPressTs = old.firstPressTs || (state.presses[0] ?? null);
      }catch{}
    }
  }
  if(!state.daily) state.daily = { lastPivot: null, todayCount: 0 };
  if(!state.dailyMap) state.dailyMap = {};

  const p = localStorage.getItem(LS_PLAN);
  if(p){ try{ plan = JSON.parse(p); }catch{} }

  const savedDiv = localStorage.getItem(LS_DIV);
  if(savedDiv){ document.getElementById('divisorSel').value = savedDiv; }

  ensurePivotAndRecount();
}

function z2(n){ return String(n).padStart(2,"0"); }
function fmtHMS(ms){
  if(ms==null || ms<=0) return "00:00:00";
  const s = Math.floor(ms/1000);
  const hh = Math.floor(s/3600);
  const mm = Math.floor((s%3600)/60);
  const ss = s%60;
  return `${z2(hh)}:${z2(mm)}:${z2(ss)}`;
}
function fmtHM(ms){
  if(ms==null || ms<0) return "—";
  const min = Math.floor(ms/60000);
  const h = Math.floor(min/60);
  const m = min%60;
  return (h>0? h+"ש ":"") + m+"ד";
}

/* ====== יום שמתחיל ב-03:00 ====== */
function pivotForTs(ts){
  const d = new Date(ts);
  const p = new Date(d);
  p.setHours(3,0,0,0);
  if(d.getTime() < p.getTime()) p.setDate(p.getDate()-1);
  return p.getTime();
}
function currentPivot(){ return pivotForTs(Date.now()); }
function dayKeyFromPivot(pivotTs){
  const d = new Date(pivotTs);
  const yyyy = d.getFullYear();
  const mm = z2(d.getMonth()+1);
  const dd = z2(d.getDate());
  return `${yyyy}-${mm}-${dd}`;
}

// מחשב את ספירת היום *אך ורק* מתוך ההיסטוריה (בלי הוספה ידנית) – FIX
function ensurePivotAndRecount(){
  const nowPivot = currentPivot();
  const prevPivot = state.daily.lastPivot;

  if(prevPivot == null){
    state.daily.lastPivot = nowPivot;
    state.daily.todayCount = state.presses.filter(ts => ts >= nowPivot).length;
    saveState();
    return;
  }

  if(nowPivot !== prevPivot){
    const prevKey = dayKeyFromPivot(prevPivot);
    const prevCount = state.presses.filter(ts => ts >= prevPivot && ts < nowPivot).length;
    state.dailyMap[prevKey] = prevCount;

    state.daily.lastPivot = nowPivot;
    state.daily.todayCount = state.presses.filter(ts => ts >= nowPivot).length;
    saveState();
  }else{
    const todayCount = state.presses.filter(ts => ts >= nowPivot).length;
    if(todayCount !== state.daily.todayCount){
      state.daily.todayCount = todayCount;
      saveState();
    }
  }
}

function checkRollover(){
  const nowP = currentPivot();
  if(nowP !== state.daily.lastPivot){
    ensurePivotAndRecount();
    updateStatsUI();
  }
}

/* ====== ממוצע אמיתי ====== */
function calcAvg(){
  const N = state.presses.length;
  if(N < 2) return "—";
  const first = state.presses[0];
  const last  = state.presses[N-1];
  let elapsed = last - first;
  if(elapsed <= 0) return "—";
  const DAY = 24*60*60*1000;
  const SLEEP = 8*60*60*1000;
  const fullDays = Math.floor(elapsed / DAY);
  elapsed -= fullDays * SLEEP;
  const denom = N - 1;
  const avg = elapsed / denom;
  return fmtHM(avg);
}

/* ====== התראות ====== */
function requestNotif(){
  if("Notification" in window && Notification.permission === "default"){
    Notification.requestPermission();
  }
}
function notify(title, body){
  if("Notification" in window && Notification.permission === "granted"){
    try{ new Notification(title, { body }); }catch{}
  }
}

/* ====== אודיו ====== */
const alarmEl = document.getElementById('alarm');
let audioPrimed = false;

function chooseRandomAlarm(){
  const i = Math.floor(Math.random()*ALARM_FILES.length);
  return ALARM_FILES[i];
}
function primeAudio(){
  if(audioPrimed) return;
  try{
    alarmEl.muted = true;
    alarmEl.loop = false;
    alarmEl.src = chooseRandomAlarm();
    alarmEl.play().then(()=>{
      alarmEl.pause(); alarmEl.currentTime = 0; alarmEl.muted = false; audioPrimed = true;
    }).catch(()=>{});
  }catch{}
}
function startAlarmLoop(){
  const src = chooseRandomAlarm();
  plan.alarmSrc = src;
  alarmEl.src = src;
  alarmEl.loop = true;
  alarmEl.currentTime = 0;
  alarmEl.play().then(()=>{
    plan.alarmActive = true; savePlan();
    document.getElementById('btnStopAlarm').style.display = 'inline-block';
  }).catch(()=>{
    document.getElementById('phaseHint').innerHTML =
      '⛔ הדפדפן חסם אודיו אוטומטי. גע במסך או לחץ "בדיקת צליל".';
  });
  notify("הגיעה תחנת עישון","לחץ כדי לעצור את האזעקה.");
}
function stopAlarmLoop(){
  alarmEl.pause(); alarmEl.currentTime = 0;
  plan.alarmActive = false; savePlan();
  document.getElementById('btnStopAlarm').style.display = 'none';
}

/* ====== תכנית (בצע) ====== */
function getDivisor(){
  const v = parseInt(document.getElementById('divisorSel').value,10);
  return (v===1 || v===2) ? v : 2;
}
function buildPlan(){
  const div = getDivisor();
  const now = new Date();
  const final = new Date(now);
  final.setHours(22,0,0,0);
  const diff = final - now;

  plan.divisor = div;
  plan.startedAt = now.getTime();
  plan.finalEndTs = final.getTime();
  plan.alarmFired = false;
  plan.alarmActive = false;
  plan.alarmSrc = null;

  if(diff <= 0){
    plan.phase = 3; plan.phaseEndTs = null;
  }else if(div === 2){
    plan.phase = 1; plan.phaseEndTs = now.getTime() + diff/2;
  }else{
    plan.phase = 2; plan.phaseEndTs = null;
  }
  savePlan();
}

/* ====== כפתורים ====== */
let smokeDisabledUntil = 0; // אנטי דאבל-קליק – FIX

function onStart(){
  if(!confirm("לאשר חישוב לוח זמנים עד 22:00?")) return;
  primeAudio(); requestNotif();
  buildPlan(); updatePlanUI();
}

function onSmoke(){
  const now = Date.now();
  if(now < smokeDisabledUntil){ return; }           // חוסם דאבל-טאץ'
  smokeDisabledUntil = now + 1500;                  // 1.5 שניות – FIX

  if(!confirm("לאשר 'עישנתי'?")) return;

  // 1) היסטוריה מלאה (לממוצע)
  state.presses.push(now);
  if(!state.firstPressTs) state.firstPressTs = now;

  // 2) ספירת יום מחושבת *רק* מההיסטוריה – בלי todayCount += 1 – FIX
  ensurePivotAndRecount();

  saveState();
  updateStatsUI();
}

function onTest(){
  primeAudio(); requestNotif();
  const src = chooseRandomAlarm();
  alarmEl.src = src; alarmEl.loop = false; alarmEl.currentTime = 0;
  alarmEl.play().then(()=>{
    setTimeout(()=>{ alarmEl.pause(); alarmEl.currentTime = 0; }, 3000);
  }).catch(()=>{ alert("נראה שהדפדפן חסם ניגון אוטומטי. נסה שוב אחרי נגיעה במסך."); });
}
function onStopAlarm(){
  if(!confirm("להפסיק את הצליל?")) return;
  stopAlarmLoop();
}

/* ====== UI ====== */
function updatePlanUI(){
  const div = plan.divisor || getDivisor();
  document.getElementById('currentDiv').textContent = String(div);

  const now = Date.now();
  const countdownEl = document.getElementById('countdown');
  const nextTimeEl  = document.getElementById('nextTime');
  const hintEl      = document.getElementById('phaseHint');

  if(plan.alarmActive){
    document.getElementById('btnStopAlarm').style.display = 'inline-block';
    if(alarmEl.paused && plan.alarmSrc){
      alarmEl.src = plan.alarmSrc; alarmEl.loop = true; alarmEl.currentTime = 0;
      alarmEl.play().catch(()=>{});
    }
  }

  if(plan.finalEndTs && now >= plan.finalEndTs){
    plan.phase = 3; savePlan();
  }

  if(plan.phase === 0){
    nextTimeEl.textContent = "—"; countdownEl.textContent = "—";
    hintEl.textContent = "אין תוכנית פעילה. לחץ 'בצע'.";
    return;
  }

  if(plan.phase === 1){
    const left = Math.max(0, (plan.phaseEndTs||0) - now);
    countdownEl.textContent = fmtHMS(left);
    nextTimeEl.textContent = new Date(plan.phaseEndTs).toLocaleTimeString("he-IL",{hour:"2-digit",minute:"2-digit"});
    hintEl.textContent = "חלק ראשון";
    if(left === 0){
      if(!plan.alarmFired){ plan.alarmFired = true; savePlan(); startAlarmLoop(); }
      plan.phase = 2; savePlan();
    }
  }else if(plan.phase === 2){
    const left = Math.max(0, (plan.finalEndTs||0) - now);
    countdownEl.textContent = fmtHMS(left);
    nextTimeEl.textContent = new Date(plan.finalEndTs).toLocaleTimeString("he-IL",{hour:"2-digit",minute:"2-digit"});
    hintEl.textContent = "חלק שני (עד 22:00)";
    if(left === 0){
      plan.phase = 3; savePlan();
      if(plan.alarmActive) stopAlarmLoop();
    }
  }else{
    nextTimeEl.textContent = "22:00";
    countdownEl.textContent = "00:00:00";
    hintEl.innerHTML = '<span class="warn">עבר 22:00 להיום</span>';
  }
}

function updateStatsUI(){
  document.getElementById('todayCount').textContent = state.daily.todayCount;
  document.getElementById('avgInterval').textContent = calcAvg();
}

/* ====== Tick ====== */
let tickSec = 0;
function tick(){
  updatePlanUI();
  checkRollover();
  tickSec = (tickSec+1)%20;
  if(tickSec===0) updateStatsUI();
}

/* ====== Init & Listeners ====== */
document.getElementById('btnStart').addEventListener('click', onStart);
document.getElementById('btnSmoke').addEventListener('click', onSmoke);
document.getElementById('btnTest').addEventListener('click', onTest);
document.getElementById('btnStopAlarm').addEventListener('click', onStopAlarm);

document.getElementById('divisorSel').addEventListener('change', ()=>{
  const div = getDivisor();
  localStorage.setItem(LS_DIV, String(div));
  document.getElementById('currentDiv').textContent = String(div);
  if(plan.phase!==0){
    if(!confirm("לעדכן את התוכנית לפי החלוקה החדשה?")) return;
    primeAudio(); buildPlan(); updatePlanUI();
  }
});

loadAll();
document.getElementById('currentDiv').textContent = String(getDivisor());
updateStatsUI();
updatePlanUI();
setInterval(tick, 1000);
</script>
</body>
</html>
