<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>××¤×œ×™×§×¦×™×™×ª ×¢×™×©×•×Ÿ</title>
  <style>
    :root{ --bg:#0b1020; --card:#121734; --muted:#9aa3b2; --text:#eaf0ff; --accent:#6ea8fe; --accent2:#70e1a1; --danger:#ff7a7a; --warn:#ffd166;}
    body{background:var(--bg);color:var(--text);font-family:Arial,system-ui;text-align:center;padding:18px;margin:0}
    .wrap{max-width:560px;margin:0 auto}
    h1{font-size:22px;margin:6px 0 12px}
    .row{display:flex;gap:10px;justify-content:center;align-items:center;flex-wrap:wrap}
    button,select{padding:12px 16px;margin:8px;border:none;border-radius:12px;font-size:16px;cursor:pointer}
    #btnStart{background:var(--accent)}
    #btnSmoke{background:var(--accent2)}
    #btnTest{background:#8bd0ff}
    #btnStopAlarm{background:var(--danger);display:none}
    .card{background:var(--card);padding:16px;margin:12px auto;border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,.25)}
    .stat{font-size:18px;margin:6px 0}
    .big{font-size:22px;font-weight:600}
    .hint{font-size:13px;color:var(--muted);margin-top:8px}
    .warn{color:var(--warn)}
  </style>
</head>
<body>
<div class="wrap">
  <h1>××¢×§×‘ ×¢×™×©×•×Ÿ</h1>

  <div class="row">
    <button id="btnStart">×‘×¦×¢</button>
    <button id="btnSmoke">×¢×™×©× ×ª×™</button>
    <button id="btnTest">×‘×“×™×§×ª ×¦×œ×™×œ ğŸ”Š</button>
    <button id="btnStopAlarm">×”×¤×¡×§ ×¦×œ×™×œ</button>
    <div>
      <label for="divisorSel">×—×œ×•×§×” ×¢×“ 22:00:</label><br>
      <select id="divisorSel">
        <option value="2" selected>2 ×—×œ×§×™×</option>
        <option value="1">×—×œ×§ ××—×“ (×¢×“ 22:00)</option>
      </select>
    </div>
  </div>

  <div class="card">
    <div class="stat">×—×œ×•×§×” × ×•×›×—×™×ª: <span id="currentDiv">2</span></div>
    <div class="stat">×”×™×¢×“ ×”×‘×: <span id="nextTime">â€”</span></div>
    <div class="stat big">×–××Ÿ ×©× ×•×ª×¨: <span id="countdown">â€”</span></div>
    <div class="hint" id="phaseHint">â€”</div>
  </div>

  <div class="card">
    <div class="stat">×›××” ×¢×™×©× ×ª×™ ×”×™×•×: <span id="todayCount">0</span></div>
    <div class="stat">×××•×¦×¢ ×‘×™×Ÿ ×¡×™×’×¨×™×•×ª: <span id="avgInterval">â€”</span></div>
    <div class="hint">×”×××•×¦×¢: ××”×œ×—×™×¦×” ×”×¨××©×•× ×”, ×¤×—×•×ª 8 ×©×¢×•×ª ×œ×›×œ 24 ×©×¢×•×ª ××œ××•×ª, ×œ×—×œ×§ ×‘××¡â€™ ×”×œ×—×™×¦×•×ª ×¤×—×•×ª ××—×ª.</div>
  </div>

  <!-- ××œ×× ×˜ ××•×“×™×• (××§×•×¨ × ×§×‘×¢ ×“×™× ××™×ª) -->
  <audio id="alarm" preload="auto"></audio>
</div>

<script>
/* ====== ×§×‘×¦×™ ×¦×œ×™×œ ====== */
const ALARM_FILES = ["alarm1.mp3","alarm2.mp3","alarm3.mp3"];

/* ====== Keys & State ====== */
const LS_STATE = "smokeAppState_v3";   // bump ×’×¨×¡×” ×›×“×™ ×œ× ×œ×“×¨×•×¡ ×”×™×¡×˜×•×¨×™×” ×§×•×“××ª
const LS_PLAN  = "smokeAppPlan_v2";
const LS_DIV   = "smokeAppDivisor_v2";

let state = {
  // ×©×•××¨ ××ª ×›×œ ×”×”×™×¡×˜×•×¨×™×” ×××– ×•××¢×•×œ×
  presses: [],        // ××¢×¨×š timestamps (ms)
  firstPressTs: null  // × ×•×—×•×ª: ×”×—×•×ª××ª ×©×œ ×”×¨××©×•× ×” (××¤×©×¨ ×œ×”×¡×™×§ ×’× ×-presses[0])
};

let plan = {
  divisor: 2,         // 2 ××• 1
  startedAt: null,    // ××ª×™ ×œ×—×¦×• "×‘×¦×¢"
  phase: 0,           // 0=××™×Ÿ, 1=×—×œ×§ ×¨××©×•×Ÿ, 2=×—×œ×§ ×©× ×™ ×¢×“ 22:00, 3=×¢×‘×¨ 22:00
  phaseEndTs: null,   // ×¡×•×£ ×”×—×œ×§ ×”×¨××©×•×Ÿ (×›×© divisor=2)
  finalEndTs: null,   // 22:00 ×”×™×•×
  alarmFired: false,  // ×›×‘×¨ ×”×•×¤×¢×œ ×¦×œ×™×œ ×‘×¡×™×•× ×—×œ×§ ×¨××©×•×Ÿ
  alarmActive: false, // ×”×× ×¦×œ×™×œ ×¨×¥ ×›×¨×’×¢ ×‘×œ×•×¤ ×•××—×›×” ×œ××™×©×•×¨ ×”×¤×¡×§×”
  alarmSrc: null      // ××™×–×” ×§×•×‘×¥ ×”×•×’×¨×œ
};

/* ====== Utils ====== */
function saveState(){ localStorage.setItem(LS_STATE, JSON.stringify(state)); }
function savePlan(){ localStorage.setItem(LS_PLAN, JSON.stringify(plan)); }
function loadAll(){
  // × ×¡×” v3
  const s3 = localStorage.getItem(LS_STATE);
  if(s3){ try{ state = JSON.parse(s3); }catch{} }
  else {
    // ×”×’×™×¨×ª v2 ×× ×™×© (×œ× ×—×•×‘×”)
    const s2 = localStorage.getItem("smokeAppState_v2");
    if(s2){
      try{
        const old = JSON.parse(s2);
        state.presses = Array.isArray(old.presses) ? old.presses : [];
        state.firstPressTs = old.firstPressTs || (state.presses[0] ?? null);
        saveState();
      }catch{}
    }
  }
  const p = localStorage.getItem(LS_PLAN);
  if(p){ try{ plan = JSON.parse(p); }catch{} }
  const savedDiv = localStorage.getItem(LS_DIV);
  if(savedDiv){ document.getElementById('divisorSel').value = savedDiv; }
}
function confirmAction(msg){ return window.confirm(msg||"×œ××©×¨?"); }

function fmtHMS(ms){
  if(ms==null || ms<=0) return "00:00:00";
  const s = Math.floor(ms/1000);
  const hh = Math.floor(s/3600);
  const mm = Math.floor((s%3600)/60);
  const ss = s%60;
  const z = n => n.toString().padStart(2,'0');
  return `${z(hh)}:${z(mm)}:${z(ss)}`;
}
function fmtHM(ms){
  if(ms==null || ms<0) return "â€”";
  const min = Math.floor(ms/60000);
  const h = Math.floor(min/60);
  const m = min%60;
  return (h>0? h+"×© ":"") + m+"×“";
}

/* ====== â€œ×™×•×â€ ×©××ª×—×™×œ ×‘-03:00 ====== */
function startOfToday3(){
  const now = new Date();
  const t = new Date(now);
  t.setHours(3,0,0,0);
  // ×× ×¢×“×™×™×Ÿ ×œ× ×”×’×¢× ×• ×œ-03:00 ×©×œ ×”×™×•× â€“ ×©×™×™×š ×œ×™×•× ×”×§×•×“×
  if(now.getTime() < t.getTime()){
    t.setDate(t.getDate()-1);
  }
  return t.getTime();
}

/* ====== Average Calc ====== */
/*
  ×××•×¦×¢ ××¨×•×•×—×™× â€œ×¤×—×•×ª 8 ×©×¢×•×ª ×•×¤×—×•×ª ×”×¨××©×•× ×”â€:
  - ×× ×™×© ×¤×—×•×ª 2 ×œ×—×™×¦×•×ª â†’ â€œâ€”â€
  - elapsed = (ts_last - ts_first)
  - fullDays = floor(elapsed / 24h)
  - elapsed -= fullDays * 8h
  - denom = (N - 1)
  - avg = elapsed / denom
*/
function calcAvg(){
  const N = state.presses.length;
  if(N < 2) return "â€”";
  const first = state.presses[0];
  const last  = state.presses[N-1];
  let elapsed = last - first;
  if(elapsed <= 0) return "â€”";
  const DAY = 24*60*60*1000;
  const SLEEP = 8*60*60*1000;
  const fullDays = Math.floor(elapsed / DAY);
  elapsed -= fullDays * SLEEP;
  const denom = N - 1;              // â€œ×¤×—×•×ª ×”×¡×™×’×¨×™×” ×”×¨××©×•× ×”â€
  const avg = elapsed / denom;
  return fmtHM(avg);
}

/* ====== Today count (03:00â†’×¢×›×©×™×•) ====== */
function countToday(){
  const sod3 = startOfToday3();
  // ×œ× ××•×—×§×™× ×”×™×¡×˜×•×¨×™×” â€” ×¨×§ ××¡× × ×™× ×œ×¤×™ ×™×•× × ×•×›×—×™
  return state.presses.filter(ts => ts >= sod3).length;
}

/* ====== Notification helper ====== */
function requestNotif(){
  if("Notification" in window){
    if(Notification.permission === "default"){
      Notification.requestPermission();
    }
  }
}
function notify(title, body){
  if("Notification" in window && Notification.permission === "granted"){
    try{ new Notification(title, { body }); }catch{}
  }
}

/* ====== Audio handling ====== */
const alarmEl = document.getElementById('alarm');
let audioPrimed = false;

function chooseRandomAlarm(){
  const i = Math.floor(Math.random()*ALARM_FILES.length);
  return ALARM_FILES[i];
}

// ×œ×¤×ª×•×— ×”×¨×©××•×ª/×¤×¨×™×™× ××•×“×™×• ×‘×œ×—×™×¦×”
function primeAudio(){
  if(audioPrimed) return;
  try{
    alarmEl.muted = true;
    alarmEl.loop = false;
    alarmEl.src = chooseRandomAlarm(); // ×˜×¢×™× ×” ×¨××©×•× ×™×ª ×©×§×˜×”
    alarmEl.play().then(()=>{
      alarmEl.pause();
      alarmEl.currentTime = 0;
      alarmEl.muted = false;
      audioPrimed = true;
    }).catch(()=>{ /* ×™×ª×›×Ÿ ×—×¡×™××”, × × ×¡×” ×©×•×‘ ×‘×œ×—×™×¦×” ××—×¨×ª */ });
  }catch{}
}

function startAlarmLoop(){
  // ×‘×—×¨ ×§×•×‘×¥ ××§×¨××™ ×œ×›×œ ××–×¢×§×”
  const src = chooseRandomAlarm();
  plan.alarmSrc = src;
  alarmEl.src = src;
  alarmEl.loop = true;
  alarmEl.currentTime = 0;

  alarmEl.play().then(()=>{
    plan.alarmActive = true;
    document.getElementById('btnStopAlarm').style.display = 'inline-block';
    savePlan();
  }).catch(()=>{
    const hint = document.getElementById('phaseHint');
    hint.innerHTML = 'â›” ×”×“×¤×“×¤×Ÿ ×—×¡× ××•×“×™×• ××•×˜×•××˜×™. ×’×¢ ×‘××¡×š ××• ×œ×—×¥ "×‘×“×™×§×ª ×¦×œ×™×œ" ×›×“×™ ×œ××¤×©×¨.';
  });

  notify("×”×’×™×¢×” ×ª×—× ×ª ×¢×™×©×•×Ÿ", "×œ×—×¥ ×›×“×™ ×œ×¢×¦×•×¨ ××ª ×”××–×¢×§×” ×•×œ×”××©×™×š ×œ×—×œ×§ ×”×©× ×™ (×¢×“ 22:00).");
}

function stopAlarmLoop(){
  alarmEl.pause();
  alarmEl.currentTime = 0;
  plan.alarmActive = false;
  document.getElementById('btnStopAlarm').style.display = 'none';
  savePlan();
}

/* ====== Plan (×‘×¦×¢) ====== */
function getDivisor(){
  const v = parseInt(document.getElementById('divisorSel').value,10);
  return (v===1 || v===2) ? v : 2;
}

function buildPlan(){
  const div = getDivisor();
  const now = new Date();
  const final = new Date(now);
  final.setHours(22,0,0,0);
  const diff = final - now;

  plan.divisor = div;
  plan.startedAt = now.getTime();
  plan.finalEndTs = final.getTime();
  plan.alarmFired = false;
  plan.alarmActive = false;
  plan.alarmSrc = null;

  if(diff <= 0){
    plan.phase = 3;
    plan.phaseEndTs = null;
  }else if(div === 2){
    plan.phase = 1;
    plan.phaseEndTs = now.getTime() + diff/2; // ×¡×•×£ ×”×—×œ×§ ×”×¨××©×•×Ÿ
  }else{ // 1
    plan.phase = 2; // ×™×©×¨ ×¢×“ 22:00
    plan.phaseEndTs = null;
  }
  savePlan();
}

/* ====== Buttons ====== */
function onStart(){
  if(!confirmAction("×œ××©×¨ ×—×™×©×•×‘ ×œ×•×— ×–×× ×™× ×¢×“ 22:00?")) return;
  primeAudio();
  requestNotif();
  buildPlan();
  updatePlanUI();
}

function onSmoke(){
  if(!confirmAction("×œ××©×¨ '×¢×™×©× ×ª×™'?")) return;
  const now = Date.now();
  state.presses.push(now);                 // ××•×¡×™×¤×™× ×œ×”×™×¡×˜×•×¨×™×” (×œ× ××•×—×§×™× ×œ×¢×•×œ×)
  if(!state.firstPressTs) state.firstPressTs = now; // × ×©××¨×ª ×¨××©×•× ×” ×œ× ×•×—×•×ª
  saveState();
  updateStatsUI();
}

function onTest(){
  // ×× ×’×Ÿ ××§×¨××™ ~3 ×©× ×™×•×ª ×•××– ×¢×•×¦×¨
  primeAudio();
  requestNotif();
  const src = chooseRandomAlarm();
  alarmEl.src = src;
  alarmEl.loop = false;
  alarmEl.currentTime = 0;
  alarmEl.play().then(()=>{
    setTimeout(()=>{
      alarmEl.pause();
      alarmEl.currentTime = 0;
    }, 3000);
  }).catch(()=>{
    alert("× ×¨××” ×©×”×“×¤×“×¤×Ÿ ×—×¡× × ×™×’×•×Ÿ ××•×˜×•××˜×™. × ×¡×” ×©×•×‘ ××—×¨×™ ×©×œ×—×¦×ª ×¢×œ ×”××¡×š.");
  });
}

function onStopAlarm(){
  if(!confirmAction("×œ×”×¤×¡×™×§ ××ª ×”×¦×œ×™×œ?")) return;
  stopAlarmLoop();
}

/* ====== UI Update ====== */
function updatePlanUI(){
  const div = plan.divisor || getDivisor();
  document.getElementById('currentDiv').textContent = String(div);

  const now = Date.now();
  const countdownEl = document.getElementById('countdown');
  const nextTimeEl  = document.getElementById('nextTime');
  const hintEl      = document.getElementById('phaseHint');

  // ×× ×“×£ × ×˜×¢×Ÿ ××—×“×© ×‘×××¦×¢ ××–×¢×§×”â€”× ×—×–×™×¨ ××•×ª×”
  if(plan.alarmActive){
    document.getElementById('btnStopAlarm').style.display = 'inline-block';
    if(alarmEl.paused && plan.alarmSrc){
      alarmEl.src = plan.alarmSrc;
      alarmEl.loop = true;
      alarmEl.currentTime = 0;
      alarmEl.play().catch(()=>{ /* ×™×™×ª×›×Ÿ ×©× ×—×¡× ×¢×“ ××’×¢ */ });
    }
  }

  // ×¢×‘×¨ 22:00?
  if(plan.finalEndTs && now >= plan.finalEndTs){
    plan.phase = 3;
    savePlan();
  }

  if(plan.phase === 0){
    nextTimeEl.textContent = "â€”";
    countdownEl.textContent = "â€”";
    hintEl.textContent = "××™×Ÿ ×ª×•×›× ×™×ª ×¤×¢×™×œ×”. ×œ×—×¥ '×‘×¦×¢'.";
    return;
  }

  if(plan.phase === 1){
    const left = Math.max(0, (plan.phaseEndTs||0) - now);
    countdownEl.textContent = fmtHMS(left);
    nextTimeEl.textContent = new Date(plan.phaseEndTs).toLocaleTimeString("he-IL",{hour:"2-digit",minute:"2-digit"});
    hintEl.textContent = "×—×œ×§ ×¨××©×•×Ÿ";
    if(left === 0){
      if(!plan.alarmFired){
        plan.alarmFired = true;
        savePlan();
        startAlarmLoop();
      }
      plan.phase = 2;
      savePlan();
    }
  }else if(plan.phase === 2){
    const left = Math.max(0, (plan.finalEndTs||0) - now);
    countdownEl.textContent = fmtHMS(left);
    nextTimeEl.textContent = new Date(plan.finalEndTs).toLocaleTimeString("he-IL",{hour:"2-digit",minute:"2-digit"});
    hintEl.textContent = "×—×œ×§ ×©× ×™ (×¢×“ 22:00)";
    if(left === 0){
      plan.phase = 3;
      savePlan();
      if(plan.alarmActive) stopAlarmLoop();
    }
  }else if(plan.phase === 3){
    nextTimeEl.textContent = "22:00";
    countdownEl.textContent = "00:00:00";
    hintEl.innerHTML = '<span class="warn">×¢×‘×¨ 22:00 ×œ×”×™×•×</span>';
  }
}

function updateStatsUI(){
  document.getElementById('todayCount').textContent = countToday();
  document.getElementById('avgInterval').textContent = calcAvg();
}

/* ====== Tick ====== */
let tickSec = 0;
function tick(){
  updatePlanUI();
  tickSec = (tickSec+1)%20;
  if(tickSec===0) updateStatsUI();
}

/* ====== Init ====== */
document.getElementById('btnStart').addEventListener('click', onStart);
document.getElementById('btnSmoke').addEventListener('click', onSmoke);
document.getElementById('btnTest').addEventListener('click', onTest);
document.getElementById('btnStopAlarm').addEventListener('click', onStopAlarm);

document.getElementById('divisorSel').addEventListener('change', ()=>{
  const div = getDivisor();
  localStorage.setItem(LS_DIV, String(div));
  document.getElementById('currentDiv').textContent = String(div);
  if(plan.phase!==0){
    if(!confirmAction("×œ×¢×“×›×Ÿ ××ª ×”×ª×•×›× ×™×ª ×œ×¤×™ ×”×—×œ×•×§×” ×”×—×“×©×”?")) return;
    primeAudio();
    buildPlan();
    updatePlanUI();
  }
});

loadAll();
document.getElementById('currentDiv').textContent = String(getDivisor());
updateStatsUI();
updatePlanUI();

// ×¨×¢× ×•×Ÿ ×›×œ ×©× ×™×™×” ×œ×¡×¤×™×¨×” ×œ××—×•×¨
setInterval(tick, 1000);
</script>
</body>
</html>
