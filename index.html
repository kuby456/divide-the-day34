let timerInterval;
let timeLeft = 0;
const today = new Date().toLocaleDateString("he-IL");
const lastDate = localStorage.getItem("lastDate");

// 🕒 בדיקה אם זה יום חדש (מאפס רק פעם ביום!)
if (lastDate !== today) {
  localStorage.setItem("lastDate", today);
  addToHistory();
  localStorage.setItem("mineCount", 0);
  localStorage.setItem("othersCount", 0);
}

// הצגת המונים
document.getElementById("mineCount").textContent = localStorage.getItem("mineCount") || 0;
document.getElementById("othersCount").textContent = localStorage.getItem("othersCount") || 0;

// 🕓 טעינת טיימר לפי זמן אמיתי
const savedEndTime = localStorage.getItem("endTime");
if (savedEndTime) {
  const remaining = Math.floor((new Date(savedEndTime) - new Date()) / 1000);
  if (remaining > 0) {
    timeLeft = remaining;
    startCountdown();
  } else {
    clearTimerStorage();
    updateDisplay(0);
  }
}

function startTimer() {
  const minutes = parseInt(document.getElementById("minutesInput").value);
  if (!minutes) return alert("הכנס זמן בדקות");

  clearInterval(timerInterval);
  timeLeft = minutes * 60;

  // חישוב שעת סיום אמיתית
  const endTime = new Date(Date.now() + timeLeft * 1000);
  localStorage.setItem("endTime", endTime.toISOString());

  updateDisplay(timeLeft);
  startCountdown();
}

function startCountdown() {
  clearInterval(timerInterval);
  timerInterval = setInterval(() => {
    const end = new Date(localStorage.getItem("endTime"));
    const diff = Math.floor((end - Date.now()) / 1000);
    if (diff <= 0) {
      clearInterval(timerInterval);
      clearTimerStorage();
      updateDisplay(0);
      alert("הטיימר הסתיים!");
    } else {
      timeLeft = diff;
      updateDisplay(timeLeft);
    }
  }, 1000);
}

function resetTimer() {
  clearInterval(timerInterval);
  clearTimerStorage();
  updateDisplay(0);
}

function clearTimerStorage() {
  localStorage.removeItem("endTime");
}

function updateDisplay(seconds) {
  const min = Math.floor(seconds / 60);
  const sec = seconds % 60;
  document.getElementById("timerDisplay").textContent =
    `${String(min).padStart(2, "0")}:${String(sec).padStart(2, "0")}`;
}

// 🔹 מונים
function addMine() {
  let count = parseInt(localStorage.getItem("mineCount") || 0);
  count++;
  localStorage.setItem("mineCount", count);
  document.getElementById("mineCount").textContent = count;
}

function addOthers() {
  let count = parseInt(localStorage.getItem("othersCount") || 0);
  count++;
  localStorage.setItem("othersCount", count);
  document.getElementById("othersCount").textContent = count;
}

// 🔹 היסטוריה
function addToHistory() {
  let history = JSON.parse(localStorage.getItem("history") || "[]");
  const mine = localStorage.getItem("mineCount") || 0;
  const others = localStorage.getItem("othersCount") || 0;
  history.push({ date: today, mine, others });
  localStorage.setItem("history", JSON.stringify(history));
}

function loadHistory() {
  const list = document.getElementById("historyList");
  list.innerHTML = "<h3>היסטוריה יומית</h3>";
  let history = JSON.parse(localStorage.getItem("history") || "[]");
  history.reverse().forEach(entry => {
    list.innerHTML += `<div class="entry">
      <b>${entry.date}</b><br>
      שלי: ${entry.mine}, מאחרים: ${entry.others}
    </div>`;
  });
}
loadHistory();
